create database eggstore
use eggstore

CREATE TABLE Privilegios
(
	IdPrivilegio int IDENTITY(1,1),
	NombrePrivilegio varchar(50)
)
CREATE TABLE Usuarios
(
	IdUsuario int IDENTITY(1,1),
	Nombres varchar(50),
	Apellidos varchar(50),
	Telefono float,
	Identificacion float,
	Correo varchar(100),
	Sector varchar(50),
	Privilegio int
)
ALTER DATABASE eggstore set Single_User with Rollback immediate
ALTER DATABASE eggstpre set multi_user

ALTER TABLE Usuarios add img image
ALTER TABLE Usuarios add usuario varchar(50)
ALTER TABLE Usuarios add contrasenia varbinary(500)

SELECT (Convert(Varchar(50), DECRYPTBYPASSPHRASE('eggstore', contrasenia))) FROM Usuarios WHERE IdUsuario = 1





--------------------------------------------------------------------------------------------------------------------
PROCEDIMIENTOS ALMACENADOS
********************************************************************************************************************


--PROCEDIMIENTO CONSULTAR
CREATE PROCEDURE SP_U_Consultar
@IdUsuarios int
as
begin
SELECT * FROM Usuarios WHERE IdUsuario=@IdUsuarios
end

--PROCEDIMIENTO INSERTAR
CREATE PROCEDURE SP_U_Insertar
@Nombres varchar(50),
@Apellidos varchar(50),
@Telefono float,
@Identificacion float,
@Correo varchar(100),
@Sector varchar(100),
@Privilegio int,
@img varchar(max),
@usuario varchar(50),
@contrasenia varchar(500),
@patron varchar(50)
as begin
INSERT INTO Usuarios values (@Nombres, @Apellidos, @Telefono, @Identificacion, @Correo, @Sector, @Privilegio, @img, @usuario,(ENCRYPTBYPASSPHRASE(@patron, @contrasenia)))
end

--PROCEDIMIENTO ELIMINAR
CREATE PROCEDURE SP_U_Eliminar
@IdUsuarios int
as
begin
DELETE FROM Usuarios WHERE IdUsuario=@IdUsuarios
end

--PROCEDIMIENTO ACTUALIZAR DATOS
CREATE PROCEDURE SP_U_ActualizarDatos
@IdUsuario int,
@Nombres varchar(50),
@Apellidos varchar(50),
@Telefono float,
@Identificacion float,
@Correo varchar(100),
@Sector varchar(100),
@Privilegio int,
@usuario varchar(50)
as begin
UPDATE Usuarios set Nombres=@Nombres, Apellidos=@Apellidos, Telefono=@Telefono, Identificacion=@Identificacion, Correo=@Correo, Sector=@Sector, Privilegio=@Privilegio, usuario=@usuario WHERE IdUsuario=@IdUsuario
end

--PROCEDIMIENTO ACTUALIZAR IMAGEN
CREATE PROCEDURE SP_U_ActualizarIMG
@IdUsuario int,
@img image
as begin
UPDATE Usuarios set img=@img WHERE IdUsuario=@IdUsuario
end

--PROCEDIMIENTO ACTUALIZAR CONTRASENIA
CREATE PROCEDURE SP_U_ActualizarPass
@IdUsuario int,
@Contrasenia varchar(500),
@patron varchar(50)
as begin
UPDATE Usuarios set contrasenia=(ENCRYPTBYPASSPHRASE(@patron, @Contrasenia)) WHERE IdUsuario=@IdUsuario
end

--PROCEDIMIENTO CARGAR USUARIOS
CREATE PROCEDURE SP_U_CargarUsuarios
as begin
SELECT * FROM Usuarios inner join Privilegios on Usuarios.Privilegio=Privilegios.IdPrivilegio
end


--PROCEDIMIENTO OBTENER NOMBRE PRIVILEGIO
CREATE PROCEDURE SP_P_NombrePrivilegio
@IdPrivilegio int
as begin
SELECT NombrePrivilegio FROM Privilegios WHERE IdPrivilegio=@IdPrivilegio
end

--PROCEDIMIENTO OBTENER ID PRIVILEGIO
CREATE PROCEDURE SP_P_IdPrivilegio
@NombrePrivilegio varchar(50)
as begin
SELECT IdPrivilegio from Privilegios WHERE NombrePrivilegio=@NombrePrivilegio
end

--PROCEDIMIENTO CARGAR PRIVILEGIOS
CREATE PROCEDURE SP_P_CargarPrivilegios
as begin
SELECT NombrePrivilegio FROM Privilegios 
end


